<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LT Weather Dashboard</title>
    <style>
        :root { --primary: #004d99; --bg: #f0f4f8; --text: #1a202c; --border: #cbd5e0; --max-temp: #e53e3e; --min-temp: #3182ce; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; -webkit-tap-highlight-color: transparent; }
        .container { background: white; border-radius: 12px; width: 100%; max-width: 800px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .history-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .history-item { background: #e2e8f0; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: none; }
        .history-item:active { background: var(--primary); color: white; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .city-badge { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .search-box { position: relative; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none; }
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border); z-index: 1000; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; display: none; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #edf2f7; cursor: pointer; }
        .weather-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 20px; }
        .day-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; }
        .date { font-weight: bold; font-size: 0.85rem; color: #4a5568; }
        .icon { font-size: 2.2rem; margin: 10px 0; }
        .temp-range { display: flex; justify-content: center; gap: 12px; font-weight: bold; }
        .max { color: var(--max-temp); }
        .min { color: var(--min-temp); }
        
        /* Modal - Clicking outside closes this */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto; position: relative; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        .hourly-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; font-size: 0.95rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div id="city-display" class="city-badge">üìç Vilnius</div>
        <a href="index.html" style="text-decoration:none; color:#718096; font-weight:bold;">‚Üê Calendar</a>
    </div>

    <div class="history-container" id="search-history"></div>

    <div class="search-box">
        <input type="text" id="city-input" placeholder="Enter city name..." autocomplete="off">
        <div id="suggestions" class="suggestions"></div>
    </div>

    <div id="weather-grid" class="weather-grid"></div>
</div>

<div class="modal-overlay" id="modal-overlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 id="modal-date" style="margin-top:0; border-bottom: 2px solid var(--bg); padding-bottom: 10px;">Day Details</h3>
        <div id="modal-content"></div>
        <p style="text-align: center; color: #718096; font-size: 0.8rem; margin-top: 20px;">Tap anywhere outside to close</p>
    </div>
</div>

<script>
    if (localStorage.getItem('isLoggedIn') !== 'true') window.location.href = 'index.html';

    const cityInput = document.getElementById('city-input');
    const suggestionsBox = document.getElementById('suggestions');
    const grid = document.getElementById('weather-grid');
    const historyBox = document.getElementById('search-history');
    
    const PROXY = "https://api.codetabs.com/v1/proxy/?quest=";
    const CACHE_TIME = 30 * 60 * 1000;
    let allPlaces = [];
    let currentForecastData = null;

    const conditionIcons = {
        "clear": "‚òÄÔ∏è", "partly-cloudy": "‚õÖ", "cloudy-with-sunny-intervals": "üå§Ô∏è",
        "cloudy": "‚òÅÔ∏è", "light-rain": "üå¶Ô∏è", "rain": "üåßÔ∏è", "heavy-rain": "‚õàÔ∏è",
        "thunder": "üå©Ô∏è", "light-snow": "üå®Ô∏è", "snow": "‚ùÑÔ∏è", "fog": "üå´Ô∏è"
    };

    async function loadPlaces() {
        try {
            const res = await fetch(PROXY + encodeURIComponent("https://api.meteo.lt/v1/places"));
            allPlaces = await res.json();
        } catch (err) { console.error("Search index failed", err); }
    }

    function updateHistory(name, code) {
        let history = JSON.parse(localStorage.getItem('weatherHistory') || '[]');
        history = history.filter(item => item.name !== name).slice(0, 4);
        history.unshift({ name, code });
        localStorage.setItem('weatherHistory', JSON.stringify(history));
        renderHistory();
    }

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem('weatherHistory') || '[]');
        historyBox.innerHTML = history.map(item => 
            `<button class="history-item" onclick="fetchWeather('${item.code}', '${item.name}')">${item.name}</button>`
        ).join('');
    }

    async function fetchWeather(code, name) {
        suggestionsBox.style.display = 'none';
        cityInput.value = '';
        document.getElementById('city-display').innerText = `üìç ${name}`;
        
        const cacheKey = `weather_${code}`;
        const cached = JSON.parse(localStorage.getItem(cacheKey));
        if (cached && (Date.now() - cached.time < CACHE_TIME)) {
            displayWeather(cached.data);
            updateHistory(name, code);
            return;
        }

        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center;">Connecting...</div>';
        
        try {
            const res = await fetch(PROXY + encodeURIComponent(`https://api.meteo.lt/v1/places/${code}/forecasts/long-term`));
            const data = await res.json();
            localStorage.setItem(cacheKey, JSON.stringify({ time: Date.now(), data: data.forecastTimestamps }));
            displayWeather(data.forecastTimestamps);
            updateHistory(name, code);
        } catch (err) {
            grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: red;">Error. <button onclick="fetchWeather('${code}', '${name}')">Retry</button></div>`;
        }
    }

    function displayWeather(timestamps) {
        currentForecastData = timestamps;
        const days = {};
        timestamps.forEach(ts => {
            const date = ts.forecastTimeUtc.split(' ')[0];
            if (!days[date]) days[date] = { temps: [], codes: [] };
            days[date].temps.push(ts.airTemperature);
            days[date].codes.push(ts.conditionCode);
        });

        grid.innerHTML = Object.entries(days).slice(0, 7).map(([date, info]) => {
            const max = Math.round(Math.max(...info.temps));
            const min = Math.round(Math.min(...info.temps));
            const displayCode = info.codes[Math.floor(info.codes.length / 2)]; 
            const d = new Date(date);
            const dayLabel = d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });

            return `
                <div class="day-card" onclick="showDetails('${date}')">
                    <div class="date">${dayLabel}</div>
                    <div class="icon">${conditionIcons[displayCode] || "‚òÅÔ∏è"}</div>
                    <div class="temp-range">
                        <span class="max">${max}¬∞</span>
                        <span class="min">${min}¬∞</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function showDetails(selectedDate) {
        const hourlyData = currentForecastData.filter(ts => ts.forecastTimeUtc.startsWith(selectedDate));
        const d = new Date(selectedDate);
        document.getElementById('modal-date').innerText = d.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });
        
        document.getElementById('modal-content').innerHTML = hourlyData.map(h => `
            <div class="hourly-item">
                <span><b>${h.forecastTimeUtc.split(' ')[1].substring(0, 5)}</b></span>
                <span>${conditionIcons[h.conditionCode] || "‚òÅÔ∏è"} ${Math.round(h.airTemperature)}¬∞C</span>
                <span style="font-size:0.85rem; color:#4a5568;">üíß${h.relativeHumidity}% üí®${h.windSpeed}m/s</span>
            </div>
        `).join('');
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
    }

    cityInput.addEventListener('input', () => {
        const val = cityInput.value.toLowerCase().trim();
        if (val.length < 2) { suggestionsBox.style.display = 'none'; return; }
        const matches = allPlaces.filter(p => p.name.toLowerCase().includes(val)).slice(0, 6);
        suggestionsBox.innerHTML = matches.map(p => `<div class="suggestion-item" onclick="fetchWeather('${p.code}', '${p.name}')">${p.name}</div>`).join('');
        suggestionsBox.style.display = matches.length ? 'block' : 'none';
    });

    renderHistory();
    loadPlaces().then(() => fetchWeather('vilnius', 'Vilnius'));
</script>
</body>
</html>